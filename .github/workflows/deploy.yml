name: Build and Upload to SquareCloud

on:
  workflow_call:
    secrets:
      SQUARE_API_KEY:
        description: "Square Cloud API Key"
        required: true
      API_ID_KEY:
        description: "Square Cloud App ID"
        required: true
      GITHUB_TOKEN:
        description: "Token para checkout"
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN || github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install
        working-directory: ./

      - name: Build project
        run: npm run build

      - name: Prepare zip
        run: |
          mkdir deploy
          cp package.json deploy/
          cp squarecloud.config deploy/
          cp -r dist deploy/
          cd deploy
          zip -r ../app.zip .
          cd ..

      - name: Run Square Cloud deployment
        run: node src/square-deploy.mjs
        env:
          SQUARE_API_KEY: ${{ secrets.SQUARE_API_KEY }}
          API_ID_KEY: ${{ secrets.API_ID_KEY }}
